<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/expandir.css">
    <link rel="stylesheet" href="css/footer.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/menuH.js"></script>
    <script src="js/usuarios.js"></script>
    <title>Vaga Fácil</title>
</head>

<body>
    <!-- Começo do Header -->
    <header>
        <nav class="nav">

            <a href=""><img class="logo" src="img/logo.png" alt="Home"></a>

            <img class="menuH" onclick="menuH()" src="img/menuH.png" alt="Menu Hamburguer">

            <div id="listaMenuH">
                <img onclick="seta()" src="img/seta.png" alt="">
                <ul class="itens-menuH">
                    <!-- <li><a href="dashboard.html">Dashboard</a></li> -->
                    <li><a href="acompanhar.html">Acompanhar</a></li>
                    <li><a href="expandir.html">Expandir</a></li>
                    <li><a href="perfil.html">Perfil</a></li>
                    <li><a href="usuarios.html">Lista de usuários</a></li>
                    <li><a href="adicionarUsuario.html">Adicionar usuário</a></li>
                    <button class="btn-site" onclick="sair()">Site Institucional</button>
                </ul>
            </div>
        </nav>
        <div id="alertSair">
            <div class="caixa">
                <h1>Deseja voltar para o Site Institucional?</h1>
                <button onclick="sim()">Sim</button>
                <button onclick="nao()">Não</button>
            </div>
        </div>
    </header>
    <!-- Fim do Header -->

    <div class="dashboard">
        <div class="containerBairro" id="divBairro">
            <div class="bairroFiltros">
                <h2><a href="Acompanhar.html"><img src="img/seta_voltar.png" alt="Retornar para página de acompanhamento"></a>Filtros</h2>
                <div>
                    Procurar um bairro:
                </div>
                <input id="inpPesquisaBairro" onkeyup="filtrarNomeERegiao()">
                <div>
                    Região: <label class="switch">
                        <input type="checkbox" onclick="changeDisabled('selRegiaoBairro'); filtrarNomeERegiao();">
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="selRegiaoBairro" onchange="filtrarNomeERegiao()" disabled="true">
                    <option value="-">- Selecione uma região -</option>
                    <option value="Norte">Norte</option>
                    <option value="Sul">Sul</option>
                    <option value="Leste">Leste</option>
                    <option value="Oeste">Oeste</option>
                    <option value="Centro">Centro</option>
                </select>

                <div>
                    Faixa de Renda: <label class="switch">
                        <input type="checkbox" onclick="changeDisabled('selRendaBairro'); filtrarRenda();">
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="selRendaBairro" onchange="filtrarRenda()" disabled="true">
                    <option value="-">- Selecione uma faixa -</option>
                    <option value="1">Baixa</option>
                    <option value="2">Média</option>
                    <option value="3">Alta</option>
                </select>

                <div>
                    Faixa Etária: <label class="switch">
                        <input type="checkbox" onclick="changeDisabled('selIdadeBairro'); filtrarIdade();">
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="selIdadeBairro" onchange="filtrarIdade()" disabled="true">
                    <option value="-">- Selecione uma faixa -</option>
                    <option value="1">Adolescente</option>
                    <option value="2">Jovem adulto</option>
                    <option value="3">Adulto</option>
                    <option value="4">Idoso</option>
                </select>
            </div>

            <div class="bairroLista" id="divBairroLista">
                <!-- <div class="bairroCard" id="cardBelaVista" onclick="mostrarRuas()">
                    <img src="img/bairros/belaVista.png">
                    <h3>Bela Vista</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardCasaVerde" onclick="mostrarRuas()">
                    <img src="img/bairros/casaVerde.png">
                    <h3>Casa Verde</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardConsolacao" onclick="mostrarRuas()">
                    <img src="img/bairros/consolacao.png">
                    <h3>Consolação</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardGuaianases" onclick="mostrarRuas()">
                    <img src="img/bairros/guaianases.png">
                    <h3>Guaianases</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardItaimBibi" onclick="mostrarRuas()">
                    <img src="img/bairros/itaimBibi.png">
                    <h3>Itaim Bibi</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardPenha" onclick="mostrarRuas()">
                    <img src="img/bairros/penha.png">
                    <h3>Penha</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardRepublica" onclick="mostrarRuas()">
                    <img src="img/bairros/republica.png">
                    <h3>República</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardSantana" onclick="mostrarRuas()">
                    <img src="img/bairros/santana.png">
                    <h3>Santana</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div>
                <div class="bairroCard" id="cardSe" onclick="mostrarRuas()">
                    <img src="img/bairros/se.png">
                    <h3>Sé</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                </div> -->

            </div>
        </div>

        <div class="containerRua" id="divRua">
            <div class="ruaFiltros">
                <h2><img src="img/seta_voltar.png" alt="Retornar para a lista de bairros" onclick="mostrarBairros()">Filtros</h2>
                <div>
                    Procurar uma rua:
                </div>
                <input id="inpPesquisaRua" onkeyup="filtrarNomeRua()">
                <div>
                    Faixa de Renda: <label class="switch">
                        <input type="checkbox" onclick="changeDisabled('selRendaRua'); filtrarRendaRua();">
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="selRendaRua" onchange="filtrarRendaRua()" disabled="true">
                    <option value="1">Baixa</option>
                    <option value="2">Média</option>
                    <option value="3">Alta</option>
                </select>
                <div>
                    Faixa Etária: <label class="switch">
                        <input type="checkbox" onclick="changeDisabled('selIdadeRua'); filtrarIdadeRua();">
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="selIdadeRua" onchange="filtrarIdadeRua()" disabled="true">
                    <option value="1">Adolescente</option>
                    <option value="2">Jovem adulto</option>
                    <option value="3">Adulto</option>
                    <option value="4">Idoso</option>
                </select>
            </div>
            <div class="ruaLista" id="divRuaLista">
                <!-- <div onclick="mostrarDados()" class="ruaCard" id="rua1">Alameda Joaquim Eugênio de Lima - Jardim
                    Paulista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua2">Rua Pamplona - Jardim Paulista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua3">Rua Peixoto Gomide - Jardim Paulista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua4">Alameda Santos - Cerqueira César</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua5">Rua Haddock Lobo - Cerqueira César</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua6">Rua Padre João Manuel - Cerqueira César</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua7">Avenida Paulista - Bela Vista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua8">Rua Pamplona - Bela Vista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua9">Rua São Carlos do Pinhal - Bela Vista</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua10">Rua Bela Cintra - Consolação</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua11">Rua Frei Caneca - Consolação</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua12">Rua Augusta - Consolação </div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua13">Rua Estados Unidos - Jardins</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua14">Alameda Lorena - Jardins</div>
                <div onclick="mostrarDados()" class="ruaCard" id="rua15">Rua da Consolação - Cerqueira César</div> -->
            </div>
        </div>

        <div class="containerDados" id="divDados">
            <div class="containerDadosFiltros">
                <div class="titulo">
                    <h2><img src="img/seta_voltar.png" alt="Retornar para a lista de ruas" onclick="mostrarRuas()">Filtros<span></span></h2>
                </div>
                <div class="endereco">
                    Endereço<br>
                    <input type="text" id="inpEndereco" class="inputWide">
                </div>
                <div class="cardContainer">
                    <div class="card">
                        <div>Tipo de dia
                            <label class="switch">
                                <input type="checkbox" onclick="changeDisabled('selTipo')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="selTipo" disabled="true">
                            <option value="semana">Dia de Semana</option>
                            <option value="fimSemana">Fim de Semana</option>
                            <option value="feriado">Feriado</option>
                        </select>
                    </div>
                    <div class="card">
                        <div>Dia da semana
                            <label class="switch">
                                <input type="checkbox" onclick="changeDisabled('selSemana')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="selSemana" disabled="true">
                            <option value="2">Segunda</option>
                            <option value="3">Terça</option>
                            <option value="4">Quarta</option>
                            <option value="5">Quinta</option>
                            <option value="6">Sexta</option>
                            <option value="7">Sabado</option>
                            <option value="1">Domingo</option>
                        </select>
                    </div>
                    <div class="card">
                        <div>Mês
                            <label class="switch">
                                <input type="checkbox" onclick="changeDisabled('selMes')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="selMes" disabled="true">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="card">
                        <div>Vaga
                            <label class="switch">
                                <input type="checkbox" onclick="changeDisabled('selVaga')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="selVaga" disabled="true">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>    
            <div class="containerGraficos">
                <div class="cardGauge">
                    <canvas id="canvGauge1" class="canvasGauge"></canvas>
                    <canvas id="canvGauge2" class="canvasGauge"></canvas>
                </div>  <div class="kpi">
                    <div class="kpiCritico">
                        Critico
                    </div>
                    <div class="kpiAlerta">
                        Alerta
                    </div>
                    <div class="kpiIdeal">
                        Bom
                    </div>
                    <div class="kpiPerfeito">
                        Ideal
                    </div>
                </div>  
                <div class="cardGrafico">
                    <canvas id="canvLine"></canvas>
                    <cavas id="canvMap"></cavas>
                </div>
            </div>
        </div>
    </div>



    <!--Início Footer-->
    <footer>
        <div class="rodape">
            <div class="container">
                <div class="cardFooter">
                    <img src="img/logo.png" id="logoFooter">
                </div>
                <div class="cardFooterCentral">
                    <ul>
                        <!-- <li>
                            <a href="dashboard.html">Dashboard</a>
                        </li> -->
                        <li>
                            <a href="Acompanhar.html">Acompanhar</a>
                        </li>
                        <li>
                            <a href="expandir.html">Expandir</a>
                        </li>
                        <li>
                            <a href="perfil.html">Perfil</a>
                        </li>
                        <li>
                            <a href="usuarios.html">Lista de usuários</a>
                        </li>
                        <li>
                            <a href="adicionarUsuario.html">Adicionar usuário</a>
                        </li>
                        <li>
                            <a href="../index.html">Site Institucional</a>
                        </li>
                    </ul>
                </div>
                <div class="cardFooter">
                    <a href=""><img src="../img/instagram.png" alt="Link para nossa página no instagram"></a>
                    <a href=""><img src="../img/facebook.png" alt="Link para nossa página no FaceBook"></a>
                    <a href=""><img src="../img/twitter.png" alt="Link para nossa página no Twitter"></a>
                </div>
            </div>
        </div>
    </footer>
    <!--Fim do Footer-->
</body>

</html>

<script>
    // Início de tela de filtros de bairro
    var cards = [];

    fetch('/expandir/listarBairro').then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    cards = resposta;
                    for (var i = 0; i < resposta.length; i++) {
                        divBairroLista.innerHTML += `<div class="bairroCard" id="card${cards[i].idBairro}" onclick="mostrarRuas(${cards[i].idBairro})">
                                <img src="img/bairros/${cards[i].idBairro}.png">
                                <h3>${cards[i].bairro}</h3>
                                <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
                            </div>`;
                        cards[i].card ='card' + cards[i].idBairro;
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
    }).catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ lista: ${error.message}`);
    });

    function filtrarNomeERegiao() {
        var nome = inpPesquisaBairro.value.toLowerCase();
        var regiao = selRegiaoBairro.value;
        if (selRegiaoBairro.disabled) {
            regiao = '-';
        }
        for (var i = 0; i < cards.length; i++) {
            if (cards[i].bairro.toLowerCase().indexOf(nome) > -1 && (cards[i].zona == regiao || regiao == '-')) {
                document.getElementById(cards[i].card).style.display = 'flex';
            } else {
                document.getElementById(cards[i].card).style.display = 'none';
            }
        }
    }

    function filtrarRenda() {
        var renda = selRendaBairro.value;
        if (selRendaBairro.disabled) {
            renda = '-';
        }

        if (renda == '-') {
            cards.sort((a, b) => a.fluxo - b.fluxo);
        } else if (renda == '1') {
            cards.sort((a, b) => a.baixa - b.baixa);
        } else if (renda == '2') {
            cards.sort((a, b) => a.media - b.media);
        } else {
            cards.sort((a, b) => a.alta - b.alta);
        }

        for (var i = 1; i <= cards.length; i++) {
            document.getElementById(cards[i-1].card).style.order = i;
        }
    }

    function filtrarIdade() {
        var idade = selIdadeBairro.value;

        if (selIdadeBairro.disabled) {
            idade = '-';
        }

        if (idade == '-') {
            cards.sort((a, b) => a.fluxo - b.fluxo);
        } else if (idade == '1') {
            cards.sort((a, b) => a.adolescente - b.adolescente);
        } else if (idade == '2') {
            cards.sort((a, b) => a.jovemAdulto - b.jovemAdulto);
        } else if (idade == '3') {
            cards.sort((a, b) => a.adulto - b.adulto);
        } else if (idade == '4') {
            cards.sort((a, b) => a.idoso - b.idoso);
        }

        for (var i = 1; i <= cards.length; i++) {
            document.getElementById(cards[i-1].card).style.order = i;
        }
    }

    function mostrarBairros() {
        divBairro.style.display = 'flex';
        divRua.style.display = 'none';
    }
    // Fim de tela de filtro de bairros

    // Início de tela de filtro de ruas
    var ruas = [];

    function mostrarRuas(idBairro) {
        divRua.style.display = 'flex';
        divBairro.style.display = 'none';
        divDados.style.display = 'none';
        fetch(`/expandir/listarRuas/${idBairro}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    divRuaLista.innerHTML = '';
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    ruas = resposta;
                    for (var i = 0; i < resposta.length; i++) {
                        divRuaLista.innerHTML += `<div onclick="mostrarDados(${ruas[0].idEndereco})" class="ruaCard" id="rua${ruas[0].idEndereco}">${ruas[0].logradouro}</div>`
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ lista: ${error.message}`);
        });
    }

    function filtrarNomeRua() {
        var nome = inpPesquisaRua.value.toLowerCase();
        for (var i = 0; i < ruas.length; i++){
            if (ruas[i].innerHTML.toLowerCase().indexOf(nome) > -1) {
                ruas[i].style.display = 'flex';
            } else {
                ruas[i].style.display = 'none';
            }
        }
    }

    function filtrarIdadeRua() {
        ruas = ruas.sort((a, b) => 0.5 - Math.random());
        for (var i = 0; i < ruas.length; i++) {
            ruas[i].style.order = i;
        }
    }

    function filtrarRendaRua() {
        ruas = ruas.sort((a, b) => 0.5 - Math.random());
        for (var i = 0; i < ruas.length; i++) {
            ruas[i].style.order = i;
        }
    }

    var dadosHistorico = {};
    var dadosTempoReal = [];

    function mostrarDados(idRua) {
        divDados.style.display = 'flex';
        divRua.style.display = 'none';
        fetch('/expandir/historicoMensal/' + idRua).then((response) => {
            if (response.ok) {
                response.json().then(function (resposta) {
                   dadosHistorico.mensal = resposta; 
                });
            }
        }).catch((erro) => {
            dadosHistorico.mensal = '';
        });

        fetch('/expandir/historicoSemanal/' + idRua).then((response) => {
            if (response.ok) {
                response.json().then(function (resposta) {
                   dadosHistorico.semanal = resposta; 
                });
            }
        }).catch((erro) => {
            dadosHistorico.semanal = '';
        });

        fetch('/expandir/historicoDiario/' + idRua).then((response) => {
            if (response.ok) {
                response.json().then(function (resposta) {
                   dadosHistorico.diario = resposta; 
                });
            }
        }).catch((erro) => {
            dadosHistorico.diario = '';
        });
    }
    // Fim de tela de filtro de ruas

    function changeDisabled(elemento) {
        var disabled = document.getElementById(elemento).disabled
        document.getElementById(elemento).disabled = !disabled;
    }

    // Início de tela de dados

    const chartGauge1 = document.getElementById('canvGauge1');
    new Chart(chartGauge1, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [15, 105],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Tempo médio de permanência',
                    color: '#F49C24',
                    font: {
                        size: 20
                    }
                },
                subtitle: {
                    display: true,
                    text: '15 mins',
                    color: '#F49C24',
                    padding: 0,
                    font: {
                        size: 16
                    }
                },
            },
            backgroundColor: ['#F49C24', '#0C243C'],
            borderColor: '#FCF4EC',
            circumference: 180,
            rotation: -90,
            cutout: '70%'
        }
    });

    const chartGauge2 = document.getElementById('canvGauge2');
    new Chart(chartGauge2, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [55, 45],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Ocupação média',
                    color: 'yellow',
                    font: {
                        size: 20
                    }
                },
                subtitle: {
                    display: true,
                    text: '55%',
                    color: 'yellow',
                    padding: 0,
                    font: {
                        size: 16
                    }
                },
            },
            backgroundColor: ['yellow', '#0C243C'],
            borderColor: '#FCF4EC',
            circumference: 180,
            rotation: -90,
            cutout: '70%'
        }
    });

    var contextoChave = document.getElementById('canvLine').getContext('2d');
    contextoChave.canvas.width = 300;
    contextoChave.canvas.height = 100;
    var cores = ['#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24', '#F49C24'];
    var chave = new Chart(
        contextoChave,
        {
            type: 'bar',
            data: {
                datasets: [{
                    label: 'Chave',
                    type: 'bar',
                    borderColor: cores,
                    backgroundColor: cores,
                }],
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Ocupação Recente',
                        color: '#F49C24',
                        font: {
                            size: 20
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: '#F49C24',
                        }
                    },
                    x: {
                        ticks: {
                            color: '#F49C24',
                        },
                    },
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: true,
                        },
                        barPercentage: 1,
                        categoryPercentage: 1
                    }],
                    yAxes: [{
                        ticks: {
                            display: true,
                            beginAtZero: true,
                        }
                    }]
                },
                animation: {
                    duration: 0
                }
            }
        }
    );

    var paginacao = {};
    var tempo = {};
    var apiOnline = true;
    function obterDados(grafico, endpoint) {
        if (apiOnline) {
            try {
                var http = new XMLHttpRequest();
                http.open('GET', 'http://localhost:3000/sensores/' + endpoint, false);
                http.send(null);
                var valores = JSON.parse(http.responseText);
            } catch (erro) {
                apiOnline = false;
                valores = [0,0,0,0,0,0,0,0,0,0];
                setTimeout(() => {apiOnline = true;}, 60000);
            }
        } else {
            valores = [0,0,0,0,0,0,0,0,0,0];
        }

        if (paginacao[endpoint] == null) {
            paginacao[endpoint] = 0;
        }
        if (tempo[endpoint] == null) {
            tempo[endpoint] = 0;
        }
        // Exibir à partir do último elemento exibido anteriormente
        var ultimaPaginacao = paginacao[endpoint];
        paginacao[endpoint] = valores.length;
        valores = valores.slice(ultimaPaginacao);
        valores.forEach((valor) => {
            //Máximo de 60 itens exibidos no gráfico
            if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                grafico.data.labels.shift();
                grafico.data.datasets[0].data.shift();
            }

            if (apiOnline) {
                grafico.data.labels.push(tempo[endpoint]++);
            } else {
                grafico.data.labels.push('');
            }
            grafico.data.datasets[0].data.push(parseFloat(valor));
            grafico.update();
        })
    }

    setInterval(() => {
        obterDados(chave, 'chave');
    }, 1000);

    // Fim de tela de dados
</script>