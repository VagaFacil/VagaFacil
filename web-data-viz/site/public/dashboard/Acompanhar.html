<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/acompanhar.css">
    <link rel="stylesheet" href="css/footer.css">
    <script src="js/menuH.js"></script>
    <script src="js/usuarios.js"></script>
    <title>Vaga Fácil</title>
</head>

<body>
    <!-- Começo do Header -->
    <header>
        <nav class="nav">

            <a href=""><img class="logo" src="img/logo.png" alt="Home"></a>

            <img class="menuH" onclick="menuH()" src="img/menuH.png" alt="Menu Hamburguer">

            <div id="listaMenuH">
                <img onclick="seta()" src="img/seta.png" alt="">
                <ul class="itens-menuH">
                    <!-- <li><a href="dashboard.html">Dashboard</a></li> -->
                    <li><a href="acompanhar.html">Acompanhar</a></li>
                    <li><a href="expandir.html">Expandir</a></li>
                    <li><a href="perfil.html">Perfil</a></li>
                    <li><a href="usuarios.html">Lista de usuários</a></li>
                    <li><a href="adicionarUsuario.html">Adicionar usuário</a></li>
                    <button class="btn-site" onclick="sair()">Site Institucional</button>
                </ul>
            </div>
        </nav>
        <div id="alertSair">
            <div class="caixa">
                <h1>Deseja voltar para o Site Institucional?</h1>
                <button onclick="sim()">Sim</button>
                <button onclick="nao()">Não</button>
            </div>
        </div>
    </header>
    <!-- Fim do Header -->

    <!-- Começo do acompanhar -->

    <div class="i-titulo">
        <h1>Acompanhar</h1>
    </div>

    <!-- Fim do acompanhar -->
    <!-- Começo do primerio banner -->
    <div class="banner1">
        <div class="unidade">
            <p>Selecione sua unidade:</p>
            <select name="" id="endereco">
                <option selected disabled value="">Selecione</option>
                <option value="1">Alameda Joaquim Eugênio de Lima, 1394 - Jardim Paulista</option>
                <option value="2">Rua Pamplona, 726 - Jardim Paulista</option>
                <option value="3">Rua Peixoto Gomide, 167 - Jardim Paulista</option>
                <option value="4">Alameda Santos, 211 - Cerqueira César</option>
                <option value="5">Rua Haddock Lobo, 595 - Cerqueira César</option>
                <option value="6">Rua Padre João Manuel, 755 - Cerqueira César</option>
                <option value="7">Avenida Paulista, 1374 - Bela Vista</option>
                <option value="8">Rua Pamplona, 145 - Bela Vista</option>
                <option value="9">Rua São Carlos do Pinhal, 424 - Bela Vista</option>
                <option value="10">Rua Bela Cintra, 1200 - Consolação</option>
                <option value="11">Rua Frei Caneca, 569 - Consolação</option>
                <option value="12">Rua Augusta, 129 - Consolação </option>
                <option value="13">Rua Estados Unidos, 1585 - Jardins</option>
                <option value="14">Alameda Lorena, 1821 - Jardins</option>
                <option value="15">Rua da Consolação, 2905 - Cerqueira César</option>
            </select>
            <Button onclick="exibirAquario()">Prosseguir</Button>
        </div>
    </div>
    <!-- Final do primeiro banner -->
    <!-- Começo do segundo banner -->
    <div class="banner2" id="banner2">
        <div class="container">
            <div class="card">

                <div class="img1">
                    <!--Começo do grafico de linha-->
                    <div class="graphCard">
                        <canvas id="myChartCanvas250000"></canvas>
                    </div>
                    <!--final-->
                </div>
                <!--Começo dos graficos de pizza-->
                <div class="grafPizza">
                    <canvas id="canvGauge1" class="canvasGauge"></canvas>
                    <canvas id="canvGauge2" class="canvasGauge"></canvas>
                </div>
                <div class="kpi">
                    <div class="kpiCritico">
                        Critico
                    </div>
                    <div class="kpiAlerta">
                        Alerta
                    </div>
                    <div class="kpiIdeal">
                        Bom
                    </div>
                    <div class="kpiPerfeito">
                        Ideal
                    </div>
                </div>
                <!--final-->
            </div>
            <div class="card">
                <div class="img3">
                    <iframe class="endereco" id="Rua1"
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3652.6125986824986!2d-46.61174760000001!3d-23.7255246!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x94ce4418ea96aeb5%3A0xa5a65e9c08945bf4!2sR.%20Ap%C3%B3stolo%20Pedro%20-%20Eldorado%2C%20Diadema%20-%20SP!5e0!3m2!1spt-BR!2sbr!4v1681738528704!5m2!1spt-BR!2sbr"
                        width="450" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!--Início Footer-->
    <footer>
        <div class="rodape">
            <div class="container">
                <div class="cardFooter">
                    <img src="img/logo.png" id="logoFooter">
                </div>
                <div class="cardFooterCentral">
                    <ul>
                        <!-- <li><a href="dashboard.html">Dashboard</a></li> -->
                        <li>
                            <a href="Acompanhar.html">Acompanhar</a>
                        </li>
                        <li>
                            <a href="expandir.html">Expandir</a>
                        </li>
                        <li>
                            <a href="perfil.html">Perfil</a>
                        </li>
                        <li>
                            <a href="usuarios.html">Lista de usuários</a>
                        </li>
                        <li>
                            <a href="adicionarUsuario.html">Adicionar usuário</a>
                        </li>
                        <li>
                            <a href="../index.html">Site Institucional</a>
                        </li>
                    </ul>
                </div>
                <div class="cardFooter">
                    <a href=""><img src="../img/instagram.png" alt="Link para nossa página no instagram"></a>
                    <a href=""><img src="../img/facebook.png" alt="Link para nossa página no FaceBook"></a>
                    <a href=""><img src="../img/twitter.png" alt="Link para nossa página no Twitter"></a>
                </div>
            </div>
        </div>
    </footer>
    <!--Fim do Footer-->
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/acompanhar.js"></script>
<script>
    /* b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    b_cpf.innerHTML = sessionStorage.CPF_USUARIO; */

    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(250000)
    }

    // verificar_autenticacao();

    /*  function alterarTitulo(idDados) {
         var tituloAquario = document.getElementById(`tituloAquario${idDados}`)
         tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + idDados + "</span>"
     } */

    function exibirAquario(idDados) {
        banner2.style.display = "block"
        /*  let todosOsGraficos = document.getElementById("img1")
 
         for (i = 1; i <= todosOsGraficos.childElementCount; i++) {
             // exibindo - ou não - o gráfico
             let elementoAtual = document.getElementById(`grafico${i}`)
             if (elementoAtual.classList.contains("display-block")) {
                 elementoAtual.classList.remove("display-block")
             }
             elementoAtual.classList.add("display-none")
             
             // alterando estilo do botão
             let btnAtual = document.getElementById(`btnAquario${i}`)
             if (btnAtual.classList.contains("btn-pink")) {
                 btnAtual.classList.remove("btn-pink")
             }
             btnAtual.classList.add("btn-white")
         }
         
         // exibindo - ou não - o gráfico
         let graficoExibir = document.getElementById(`grafico${idDados}`)
         graficoExibir.classList.remove("display-none")
         graficoExibir.classList.add("display-block")
         
         // alterando estilo do botão
         let btnExibir = document.getElementById(`btnAquario${idDados}`)
         btnExibir.classList.remove("btn-white")
         btnExibir.classList.add("btn-pink") */
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idDados) {

        // alterarTitulo(idDados)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/acompanhar/ultimas/${idDados}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idDados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idDados) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [ ];

        // Criando estrutura para plotar gráfico - dados
        let dados = {

            labels: labels,
            datasets: [
            {
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: '#F49C24',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            var hora = new Date(registro.dataHora);
            labels.push(hora.getHours() + ':' + hora.getMinutes());
            // dados.datasets[0].data.push(registro.umidade);
            dados.datasets[0].data.push(registro.valor);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Ocupação total da rua',
                        color: '#F49C24',
                        font:{
                            size: 20
                        }
                    },
                    legend:{
                        display: false
                    }
                }
            },
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idDados}`),
            config
        );

        setTimeout(() => atualizarGrafico(idDados, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idDados, dados, myChart) {



        fetch(`/acompanhar/tempo-real/${idDados}`, { cache: 'no-store' }).then(function (response) {
            console.log(response)
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idDados}`)
                    // avisoCaptura.innerHTML = ""
                     var hora = new Date(novoRegistro[0].dataHora);

                    if ((hora.getHours() + `:` + hora.getMinutes()) == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].dataHora)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                       
                        dados.labels.push(hora.getHours() + `:` + hora.getMinutes()); // incluir um novo momento

                       /*  dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade
 */
                        dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        
                        dados.datasets[0].data.push(novoRegistro[0].valor); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idDados, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idDados, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>